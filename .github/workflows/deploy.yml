name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy using git
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@167.172.210.140 << 'EOF'
            # Clone or update repository in /opt
            if [ ! -d "/opt/korat-church" ]; then
              git clone https://github.com/Vichet-ops/korat-church.git /opt/korat-church
            fi
            
            cd /opt/korat-church
            git pull origin main
            
            # Build frontend
            cd frontend
            npm ci
            VITE_API_URL=https://vichetkeo.com npm run build
            cp -r dist/* /var/www/church-website/
            
            # Build backend
            cd ..
            go build -o korat-church main.go
            cp korat-church /var/www/church-website/
            
            # Setup database
            sudo -u postgres psql -c "CREATE DATABASE church_db;" 2>/dev/null || true
            sudo -u postgres psql -c "CREATE USER church_user WITH PASSWORD 'church123';" 2>/dev/null || true
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE church_db TO church_user;"
            PGPASSWORD='church123' psql -h localhost -U church_user -d church_db -f scripts/setup-production-database.sql
            
            # Restart backend
            cd /var/www/church-website
            pkill -f korat-church || true
            export DATABASE_URL='postgres://church_user:church123@localhost:5432/church_db?sslmode=disable'
            export JWT_SECRET='your-production-jwt-secret'
            export GIN_MODE=release
            export PORT=8080
            nohup ./korat-church > korat-church.log 2>&1 &
            
            echo "âœ… Deployment completed!"
          EOF
