name: Deploy

on:
  push:
    branches: [main]

jobs:
  upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          echo "VITE_API_URL=https://vichetkeo.com" > .env.production
          npm run build

      - name: Build backend
        run: |
          go mod download
          GOOS=linux GOARCH=amd64 go build -o church-app main.go

      - name: Upload files
        env:
          DROPLET_HOST: ${{ secrets.DROPLET_HOST }}
          DROPLET_USER: ${{ secrets.DROPLET_USER }}
          DROPLET_KEY: ${{ secrets.DROPLET_KEY }}
          DROPLET_PATH: ${{ secrets.DROPLET_PATH }}
        run: |
          mkdir -p ~/.ssh
          echo "$DROPLET_KEY" > ~/.ssh/key
          chmod 600 ~/.ssh/key
          
          # Just upload files - no complex commands
          scp -i ~/.ssh/key -o StrictHostKeyChecking=no -r frontend/dist/* $DROPLET_USER@$DROPLET_HOST:/var/www/vichetkeo.com/html/
          scp -i ~/.ssh/key -o StrictHostKeyChecking=no church-app $DROPLET_USER@$DROPLET_HOST:$DROPLET_PATH/
          
          echo "âœ… Files uploaded!"
