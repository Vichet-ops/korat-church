name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy using git
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@167.172.210.140 << 'EOF'
            cd /opt/korat-church
            git pull origin main
            
            # Build frontend
            cd frontend
            npm ci
            VITE_API_URL=https://vichetkeo.com npm run build
            cp -r dist/* /var/www/church-website/
            
            # Build backend
            cd ..
            go build -o korat-church main.go
            
            # Restart backend
            pkill -f korat-church || true
            nohup ./korat-church > korat-church.log 2>&1 &
            
            echo "âœ… Deployment completed!"
          EOF
