name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          VITE_API_URL=https://vichetkeo.com npm run build

      - name: Build backend
        run: |
          go mod download
          GOOS=linux GOARCH=amd64 go build -o church-app main.go

      - name: Deploy to server
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy files
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -r frontend/dist/* root@165.232.163.96:/var/www/vichetkeo.com/

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            church-app root@165.232.163.96:/opt/church-app/

          # Restart backend
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@165.232.163.96 \
            "cd /opt/church-app && \
             pkill -f church-app || true && \
             chmod +x church-app && \
             nohup ./church-app > church-app.log 2>&1 &"

          echo "âœ… Deployment completed!"
