name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          VITE_API_URL=https://vichetkeo.com npm run build

      - name: Build backend
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o korat-church main.go

      - name: Deploy to server
        env:
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Stop backend before uploading
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@167.172.210.140 \
            "pkill -f korat-church || true"

          # Upload files
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            -r frontend/dist/* root@167.172.210.140:/var/www/church-website/

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            korat-church root@167.172.210.140:/var/www/church-website/

          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            scripts/setup-production-database.sql root@167.172.210.140:/tmp/

          # Setup database and restart
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@167.172.210.140 << 'EOF'
            # Setup database (create if doesn't exist)
            sudo -u postgres psql -c "CREATE DATABASE church_db;" 2>/dev/null || true
            sudo -u postgres psql -c "CREATE USER church_user WITH PASSWORD 'church123';" 2>/dev/null || true
            sudo -u postgres psql -c "ALTER USER church_user WITH PASSWORD 'church123';"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE church_db TO church_user;"
            sudo -u postgres psql -c "ALTER USER church_user WITH SUPERUSER;"
            
            # Run database setup script
            sudo -u postgres psql -d church_db -f /tmp/setup-production-database.sql
            
            # Start backend
            cd /var/www/church-website
            chmod +x korat-church
            
            export DATABASE_URL='postgres://church_user:church123@localhost:5432/church_db?sslmode=disable'
            export JWT_SECRET='your-production-jwt-secret'
            export GIN_MODE=release
            export PORT=8080
            nohup ./korat-church > korat-church.log 2>&1 &
            
            sleep 3
            echo "âœ… Deployment completed!"
          EOF
